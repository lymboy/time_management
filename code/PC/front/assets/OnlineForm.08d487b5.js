import{f5 as dt,dJ as mt,C as p,a8 as pt,m as ht,bI as gt,r as y,s as B,t as M,v as F,R as me,Q as pe,w as j,ax as bt,bc as yt,V as Ft,S as vt,ac as A,f8 as _t,Z as X,n as St,fh as Ct,u as Pt,K as he,G as ge}from"./index.d13d32e3.js";import{B as wt}from"./BasicForm.e6ef05c4.js";import"./componentMap.6f8f51f6.js";import{u as Ot}from"./useForm.1a92e1aa.js";import"./JAddInput.ec01e271.js";import{V as I,S as Tt,b as Bt,O as be}from"./FormSchemaFactory.4d3f70be.js";import{O as Et,P as kt,D as At,a as Dt,u as xt,b as Rt,c as Vt,l as U,g as Mt}from"./useAutoForm.b2fe16b6.js";import"./index.1c9272fa.js";import{p as jt}from"./pick.2cb7a7a2.js";import{o as ye}from"./omit.f85ed7ec.js";import"./JUpload.vue_vue_type_style_index_0_lang.e5aaf763.js";import"./JUploadModal.vue_vue_type_script_setup_true_lang.0c9bff57.js";import"./OnlineSelectCascade.dcd3a21e.js";import{F as It}from"./BasicTable.vue_vue_type_style_index_0_lang.734e51fc.js";import"./TableImg.vue_vue_type_style_index_0_lang.c653d5f6.js";import"./Area.34bf1346.js";import"./functional.fdb540f5.js";import"./LinkTableListPiece.ef0939db.js";import"./_flatRest.298c1393.js";import"./isArray.bed9f286.js";import"./toString.f51d8d11.js";import"./_arrayPush.f667b98f.js";import"./_baseClone.2b814275.js";import"./BasicForm.vue_vue_type_style_index_0_lang.46537c39.js";import"./uniqBy.0dfdca3d.js";import"./BasicModal.d291574e.js";import"./useWindowSizeFn.67dc54bf.js";import"./useFormItem.7e3b9788.js";import"./download.1bc5d3ce.js";import"./base64Conver.030fa32c.js";import"./index.12d9094a.js";import"./index.d11dcab2.js";import"./useCountdown.ea4711fe.js";import"./index.5b75652b.js";import"./index.e9229284.js";import"./areaDataUtil.b0d6c4f6.js";import"./api.ae3b9cbd.js";import"./props.b623f34d.js";import"./index.61b0c164.js";import"./bem.0a70e06a.js";import"./props.1766c95e.js";import"./useContextMenu.17d08add.js";import"./index.89ad7068.js";import"./onMountedOrActivated.a5139741.js";import"./index.9bf7bffc.js";import"./htmlmixed.470d5886.js";import"./vue.aa2fc71b.js";/* empty css             */import"./depart.api.0bd5897e.js";import"./user.api.bbb5fbe4.js";import"./_commonjsHelpers.238e4417.js";import"./customExpression.05dc2408.js";import"./BasicTable.7f769694.js";import"./index.9013d2b9.js";import"./useContentHeight.729fdab1.js";import"./useContentViewHeight.c21fb651.js";import"./usePageContext.a7636151.js";import"./RedoOutlined.a7479f77.js";import"./useListPage.6b1e9ff2.js";import"./useTable.c77f7905.js";import"./JModalTip.00279615.js";import"./EditOutlined.cf2b97fa.js";import"./_baseSlice.213136cd.js";var Nt=Object.defineProperty,Fe=Object.getOwnPropertySymbols,Jt=Object.prototype.hasOwnProperty,Lt=Object.prototype.propertyIsEnumerable,ve=(u,s,a)=>s in u?Nt(u,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):u[s]=a,q=(u,s)=>{for(var a in s||(s={}))Jt.call(s,a)&&ve(u,a,s[a]);if(Fe)for(var a of Fe(s))Lt.call(s,a)&&ve(u,a,s[a]);return u},P=(u,s,a)=>new Promise((i,E)=>{var S=h=>{try{v(a.next(h))}catch(d){E(d)}},w=h=>{try{v(a.throw(h))}catch(d){E(d)}},v=h=>h.done?i(h.value):Promise.resolve(h.value).then(S,w);v((a=a.apply(u,s)).next())});const $={optPre:"/online/cgform/api/form/",urlButtonAction:"/online/cgform/api/doButton"},Ut={name:"OnlineForm",components:{BasicForm:wt,Loading:mt,OnlineSubForm:Et,PrinterOutlined:kt,DiffOutlined:At,FormOutlined:It,OnlinePopModal:Dt},props:{id:{type:String,default:""},formTemplate:{type:Number,default:1},disabled:{type:Boolean,default:!1},isTree:{type:Boolean,default:!1},pidField:{type:String,default:""},submitTip:{type:Boolean,default:!0}},emits:["success","rendered"],setup(u,{emit:s}){console.log("onlineForm-setup\u300B\u300B");const{createMessage:a}=Pt(),i=p(null),E=p(!0),S=p(!1),w=p(1),v=p(""),h=p(!1),d=p(!1),O=pt({reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:"",commentStatus:0}),{onlineFormContext:c,resetContext:K}=xt(),{formSchemas:D,defaultValueFields:k,changeDataIfArray2String:N,tableName:T,dbData:r,checkOnlyFieldValue:W,hasSubTable:g,subTabInfo:x,refMap:H,subDataSource:J,baseColProps:_e,createFormSchemas:Se,linkDownList:zt,fieldDisplayStatus:R}=Rt(u,i);let{EnhanceJS:f,initCgEnhanceJs:Ce}=Vt(c,!1);const[Pe,{setProps:we,validate:ee,resetFields:te,setFieldsValue:C,updateSchema:z,getFieldsValue:Q,scrollToField:Oe}]=Ot({schemas:D,showActionButtonGroup:!1,baseColProps:_e}),le=p(!1);function Te(){let e=u.disabled;le.value=e,we({disabled:e})}function Be(e,t,l){return P(this,null,function*(){console.log("\u65B0\u589E\u7F16\u8F91\u8FDB\u5165\u8868\u5355\u300B\u300Bform",t),yield Ee(),v.value="",yield te(),r.value="";let o=he(e);d.value=o,o?yield ne(t):ie(),ge(()=>{!o&&l&&C(l),ke(),G("js","loaded"),Te()})})}function Ee(){return P(this,null,function*(){if(u.isTree===!0){let e=u.pidField,t=D.value;t&&t.length>0?t.filter(o=>o.field===e).length>0&&(yield z({field:e,componentProps:{reload:new Date().getTime()}})):console.log("\u6CA1\u6709\u62FF\u5230\u8868\u5355\u914D\u7F6E\u4FE1\u606F\uFF0C\u53EF\u80FD\u662F\u7B2C\u4E00\u6B21\u6253\u5F00\u65B0\u589E\u9875\u9762")}})}function ke(){if(he(d)===!1){let e=A(k[T.value]);U(e,t=>{C(t)})}}function oe(e,t){let l=A(k[e.key]);U(l,o=>{const{row:n,target:m}=t;let _=[{rowKey:n.id,values:q({},o)}];m.setValues(_)})}function ne(e){return P(this,null,function*(){let t=yield De(e.id);r.value=Object.assign({},e,t);let l=Ae.value,o=jt(t,...l);u.disabled&&Object.keys(o).map(n=>{!o[n]&&o[n]!==0&&o[n]!=="0"&&delete o[n]}),yield C(o),ie(t)})}function ie(e){e||(e={});let t=Object.keys(J.value);if(t&&t.length>0){let l={};for(let o of t)l[o]=e[o]||[];J.value=l}}let Ae=ht(()=>{let e=D.value,t=[];for(let l of e)t.push(l.field);return t});function De(e){let t=`${$.optPre}${u.id}/${e}`;return new Promise((l,o)=>{X.get({url:t},{isTransformResponse:!1}).then(n=>{n.success?l(n.result):(o(),a.warning(n.message))}).catch(()=>{o()})})}function xe(e){return P(this,null,function*(){w.value=e.head.tableType,T.value=e.head.tableName,E.value=e.head.tableType==1,Re(e.head.extConfigJson),Se(e.schema.properties,e.schema.required,W),f=Ce(e.enhanceJs),s("rendered",O);let t=yield Mt(i);t.$formValueChange=(l,o,n)=>{Ye(l,o),n&&C(n)}})}function Re(e){let t={reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:1,modalMinWidth:"",commentStatus:0};e&&(t=JSON.parse(e)),Object.keys(t).map(l=>{O[l]=t[l]})}function Ve(){E.value===!0?Je():Me()}function Me(){je().then(e=>{re(e)})}function je(){let e={};return new Promise((t,l)=>{ee().then(o=>t(o),({errorFields:o})=>{o&&o.length>0&&Oe(o[0][0]),l(I)})}).then(t=>(Object.assign(e,N(t)),Ne())).then(t=>(Object.assign(e,t),Promise.resolve(e))).catch(t=>(t===I||(t==null?void 0:t.code)===I?(a.warning("\u6821\u9A8C\u672A\u901A\u8FC7"),t.key&&Ie(t.key)):console.error(t),Promise.reject(null)))}function Ie(e){let t=x.value;for(let l=0;l<t.length;l++)if(e==t[l].key){let o=l+"";if(L.value===o)break;if(L.value=o,t[l].relationType===0){let n=b(e);_t(300,()=>n==null?void 0:n.validateTable())}break}}function Ne(){return new Promise((e,t)=>P(this,null,function*(){let l={};try{let o=x.value;for(let n=0;n<o.length;n++){let m=o[n].key,_=b(m);if(o[n].relationType==1)try{let V=yield _.getAll();l[m]=[],l[m].push(V)}catch(V){throw{code:I,key:m}}else{if(yield _.fullValidateTable())throw{code:I,key:m};l[m]=_.getTableData()}}}catch(o){t(o)}e(l)}))}function Je(){return P(this,null,function*(){try{let e=yield ee();e=Object.assign({},r.value,e),e=N(e),S.value=!0,re(e)}finally{S.value=!1}})}function re(e){$e(de,e).then(()=>{Le(e)}).catch(t=>{a.warning(t)})}function Le(e){Object.keys(e).map(n=>{Array.isArray(e[n])&&e[n].length==0&&(e[n]="")}),console.log("\u63D0\u4EA4\u8868\u5355\u6570\u636E\u300B\u300B\u300Bform:",e);let t=v.value,l=`${$.optPre}${u.id}?tabletype=${w.value}`;t&&(l=`${t}?tabletype=${w.value}`),h.value===!0&&(e[Tt]=1);let o=d.value===!0?"put":"post";X.request({url:l,method:o,params:e},{isTransformResponse:!1}).then(n=>{n.success?(n.result&&(e[Bt]=n.result),s("success",e),u.submitTip===!0&&a.success(n.message)):a.warning(n.message)}).finally(()=>{S.value=!1})}function Ue(e,t,l){t&&l?l.vxeProps?l.setValues([{rowKey:t,values:e}]):l.setValues(e):C(e)}function qe(e,t){let l={};l[e]=t,C(l)}const L=p("0"),ae=p(300),ue=p(340);function Ke(e){if(d.value===!0){let t=r.value;return We(t,e)}return""}function We(e,t){if(e){let l=e[t];return!l&&l!==0&&(l=e[t.toLowerCase()],!l&&l!==0&&(l=e[t.toUpperCase()])),l}return""}function He(e,t){if(f&&f[t+"_onlChange"]){let l=f[t+"_onlChange"](),o=Object.keys(e)[0];if(l[o]){let m=b(t).getFormEvent(),_=q({column:{key:o},value:e[o]},m);l[o].call(c,c,_)}}}function ze(e,t){if(f&&f[t+"_onlChange"]){let l=f[t+"_onlChange"](c);if(e.column==="all"){let o=Object.keys(l);if(o.length>0)for(let n of o)l[n].call(c,c,e)}else{let o=e.column.key||e.col.key;l[o]&&e.row&&e.row.id&&l[o].call(c,c,e)}}}function Qe(e,t){console.log("handleAdded",e,t),oe(e,t)}function Ge(e){return"online_"+e+":"}function Ye(e,t){return P(this,null,function*(){if(!f||!f.onlChange||!e)return!1;let l=f.onlChange();if(l[e]){let n={row:yield Q(),column:{key:e},value:t};l[e].call(c,c,n)}})}function G(e,t){if(e=="js")f&&f[t]&&f[t].call(c,c);else if(e=="action"){let l=r.value,o={formId:u.id,buttonCode:t,dataId:l.id,uiFormData:Object.assign({},l)};X.post({url:`${$.urlButtonAction}`,params:o},{isTransformResponse:!1}).then(n=>{n.success?a.success("\u5904\u7406\u5B8C\u6210!"):a.warning("\u5904\u7406\u5931\u8D25!")})}}function se(e){let t=b(e),l=[...t.getNewDataWithId(),...J.value[e]];if(!l||l.length==0)return!1;let o=[];for(let n of l)o.push(n.id);t.removeRowsById(o)}function fe(e,t){if(!t)return!1;let l=b(e);typeof t=="object"?l.addRows(t,!0):this.$message.error("\u6DFB\u52A0\u5B50\u8868\u6570\u636E,\u53C2\u6570\u4E0D\u8BC6\u522B!")}function Ze(e,t){se(e),fe(e,t)}function Xe(e,t){!t&&t.length<=0&&(t=[]),t.map(l=>{l.hasOwnProperty("label")||(l.label=l.text)}),z({field:e,componentProps:{options:t}})}function $e(e,t){return f&&f.beforeSubmit?f.beforeSubmit(e,t):Promise.resolve()}function et(e,t){let l=A(R);e&&e.length>0?Object.keys(l).map(o=>{!o.endsWith("_load")&&e.indexOf(o)<0&&(R[o]=!1)}):t&&t.length>0&&Object.keys(l).map(o=>{t.indexOf(o)>=0&&(R[o]=!1)})}function tt(e,t){return P(this,null,function*(){console.log("\u81EA\u5B9A\u4E49\u5F39\u7A97\u6253\u5F00online\u8868\u5355\u300B\u300Bform",e),v.value=t,yield te(),r.value="",d.value=!0,yield ne(e),yield ge(()=>{G("js","loaded")})})}function b(e){let t=H[e].value;if(t instanceof Array&&(t=t[0]),!t){a.warning("\u5B50\u8868ref\u627E\u4E0D\u5230:"+e);return}return t}function lt(){let e=O.reportPrintUrl,t=r.value.id,l=St();Ct(e,t,l)}const[ot,{openModal:ce}]=gt(),Y=p(""),Z=p(!0);function nt(e){console.log("openSubFormModalForAdd",e),Y.value=e.id,Z.value=!1,ce(!0,{isUpdate:!1})}function it(e){let l=b(e.key).getSelectedData();if(l.length!=1){a.warning("\u8BF7\u9009\u62E9\u4E00\u6761\u6570\u636E");return}Y.value=e.id,Z.value=!1,ce(!0,{isUpdate:!0,record:l[0]})}function rt(e){const t=e[be];let l=ye(e,[be]);if(l.id){let o=ye(q({},l),"id"),n=[{rowKey:l.id,values:o}];b(t).setValues(n)}else b(t).addRows(l,{isOnlineJS:!1,setActive:!1,emitChange:!0})}function at(){let e=x.value;if(e&&e.length>0){for(let t of e)if(t.relationType!=1){let l=b(t.key);l&&l.clearSelection()}}}function ut(){let e=Q(),t=A(k[T.value]);U(t,l=>{C(l)},e)}function st(e,t){let l=x.value;if(l&&l.length>0){let o=l.filter(n=>n.key===e);if(o.length==0){console.error("\u6CA1\u627E\u5230\u4E0E\u4E4B\u5339\u914D\u7684\u5B50\u8868",e);return}if(o[0].relationType==1)b(e).executeFillRule();else{let n=A(k[e]),m=A(t.row);U(n,_=>{const{row:V,target:ft}=t;let ct=[{rowKey:V.id,values:q({},_)}];ft.setValues(ct)},m)}}}let de={tableName:T,loading:S,subActiveKey:L,onlineFormRef:i,getFieldsValue:Q,setFieldsValue:C,submitFlowFlag:h,subFormHeight:ae,subTableHeight:ue,refMap:H,triggleChangeValues:Ue,triggleChangeValue:qe,sh:R,clearSubRows:se,addSubRows:fe,clearThenAddRows:Ze,changeOptions:Xe,isUpdate:d,getSubTableInstance:b,updateSchema:z,executeMainFillRule:ut,executeSubFillRule:st};return K(de),{tableName:T,onlineFormRef:i,registerForm:Pe,loading:S,subActiveKey:L,hasSubTable:g,subTabInfo:x,refMap:H,subFormHeight:ae,getSubTableForeignKeyValue:Ke,isUpdate:d,handleSubFormChange:He,subTableHeight:ue,onlineFormDisabled:le,subDataSource:J,getSubTableAuthPre:Ge,handleAdded:Qe,handleSubTableDefaultValue:oe,handleValueChange:ze,openSubFormModalForAdd:nt,openSubFormModalForEdit:it,show:Be,createRootProperties:xe,handleSubmit:Ve,sh:R,handleCgButtonClick:G,handleCustomFormSh:et,handleCustomFormEdit:tt,dbData:r,onOpenReportPrint:lt,onlineExtConfigJson:O,registerPopModal:ot,popTableName:Y,getPopFormData:rt,popModalRequest:Z,onCloseModal:at}}},qt=["id"],Kt={key:0,style:{"text-align":"right",position:"absolute",top:"6px",right:"20px","z-index":"999"}},Wt={key:1};function Ht(u,s,a,i,E,S){const w=y("PrinterOutlined"),v=y("BasicForm"),h=y("online-sub-form"),d=y("diff-outlined"),O=y("a-button"),c=y("form-outlined"),K=y("JVxeTable"),D=y("a-tab-pane"),k=y("a-tabs"),N=y("Loading"),T=y("online-pop-modal");return B(),M("div",{id:i.tableName+"_form"},[!!i.dbData.id&&!!i.onlineExtConfigJson.reportPrintShow?(B(),M("div",Kt,[F(w,{title:"\u6253\u5370",onClick:i.onOpenReportPrint,style:{"font-size":"16px"}},null,8,["onClick"])])):me("",!0),F(v,{ref:"onlineFormRef",onRegister:i.registerForm},null,8,["onRegister"]),i.hasSubTable?(B(),pe(k,{key:1,activeKey:i.subActiveKey,"onUpdate:activeKey":s[0]||(s[0]=r=>i.subActiveKey=r)},{default:j(()=>[(B(!0),M(bt,null,yt(i.subTabInfo,(r,W)=>(B(),pe(D,{tab:r.describe,key:W+"",forceRender:!0},{default:j(()=>[r.relationType==1?(B(),M("div",{key:0,style:Ft({"overflow-y":"auto","overflow-x":"hidden","max-height":i.subFormHeight+"px"})},[F(h,{ref_for:!0,ref:i.refMap[r.key],table:r.key,disabled:i.onlineFormDisabled,"form-template":a.formTemplate,"main-id":i.getSubTableForeignKeyValue(r.foreignKey),properties:r.properties,"required-fields":r.requiredFields,"is-update":i.isUpdate,onFormChange:g=>i.handleSubFormChange(g,r.key)},null,8,["table","disabled","form-template","main-id","properties","required-fields","is-update","onFormChange"])],4)):(B(),M("div",Wt,[F(K,{ref_for:!0,ref:i.refMap[r.key],toolbar:"","keep-source":"","row-number":"","row-selection":"",height:i.subTableHeight,disabled:i.onlineFormDisabled,columns:r.columns,dataSource:i.subDataSource[r.key],onValueChange:g=>i.handleValueChange(g,r.key),authPre:i.getSubTableAuthPre(r.key),onAdded:g=>i.handleAdded(r,g),onExecuteFillRule:g=>i.handleSubTableDefaultValue(r,g)},{toolbarSuffix:j(()=>[F(O,{type:"primary",onClick:g=>i.openSubFormModalForAdd(r)},{default:j(()=>[F(d)]),_:2},1032,["onClick"]),F(O,{type:"primary",onClick:g=>i.openSubFormModalForEdit(r)},{default:j(()=>[F(c)]),_:2},1032,["onClick"])]),_:2},1032,["height","disabled","columns","dataSource","onValueChange","authPre","onAdded","onExecuteFillRule"])]))]),_:2},1032,["tab"]))),128))]),_:1},8,["activeKey"])):me("",!0),F(N,{loading:i.loading,absolute:!1},null,8,["loading"]),vt(u.$slots,"bottom"),F(T,{request:i.popModalRequest,id:i.popTableName,onRegister:i.registerPopModal,onSuccess:i.getPopFormData,topTip:"",isVxeTableData:""},null,8,["request","id","onRegister","onSuccess"])],8,qt)}var oo=dt(Ut,[["render",Ht]]);export{oo as default};
