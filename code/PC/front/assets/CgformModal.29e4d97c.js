import{Z as F,j as Ke,I as Ve,C as g,m as ee,bB as te,bH as qe,a8 as Ue,bI as He,f5 as Ge,f8 as L,G,b1 as ze,r as f,s as w,Q as z,w as d,v as r,y as k,t as ae,ax as Ye,bc as We,z as Ze,R as le,aW as oe,x as Xe,ac as et,bN as tt,u as at}from"./index.d13d32e3.js";import{B as lt}from"./index.1c9272fa.js";import{B as ot}from"./BasicForm.e6ef05c4.js";import"./componentMap.6f8f51f6.js";import{u as nt}from"./useForm.1a92e1aa.js";import"./JAddInput.ec01e271.js";import{u as it}from"./useSchemas.4122dc6d.js";import rt from"./DBAttributeTable.3deeef14.js";import st from"./PageAttributeTable.b4f97b29.js";import ut from"./CheckDictTable.803d0299.js";import dt from"./ForeignKeyTable.173b85f6.js";import ct from"./IndexTable.e61cde26.js";import ft from"./QueryTable.184057a7.js";import bt from"./ExtendConfigModal.06178baa.js";import{u as pt,E as mt,a as Tt,V as I}from"./cgform.data.ea831fae.js";import{u as gt}from"./useOnlineTest.f4db9c80.js";import{g as yt}from"./useAutoForm.b2fe16b6.js";import"./BasicModal.d291574e.js";import"./useWindowSizeFn.67dc54bf.js";import"./BasicForm.vue_vue_type_style_index_0_lang.46537c39.js";import"./uniqBy.0dfdca3d.js";import"./useFormItem.7e3b9788.js";import"./functional.fdb540f5.js";import"./download.1bc5d3ce.js";import"./base64Conver.030fa32c.js";import"./index.12d9094a.js";import"./index.d11dcab2.js";import"./useCountdown.ea4711fe.js";import"./JUpload.vue_vue_type_style_index_0_lang.e5aaf763.js";import"./api.ae3b9cbd.js";import"./index.5b75652b.js";import"./index.e9229284.js";import"./areaDataUtil.b0d6c4f6.js";import"./props.b623f34d.js";import"./index.61b0c164.js";import"./bem.0a70e06a.js";import"./props.1766c95e.js";import"./useContextMenu.17d08add.js";import"./index.89ad7068.js";import"./onMountedOrActivated.a5139741.js";import"./index.9bf7bffc.js";import"./htmlmixed.470d5886.js";import"./vue.aa2fc71b.js";/* empty css             */import"./depart.api.0bd5897e.js";import"./validator.4907239b.js";import"./user.api.bbb5fbe4.js";import"./useTableSync.30c3c307.js";import"./pick.2cb7a7a2.js";import"./_flatRest.298c1393.js";import"./isArray.bed9f286.js";import"./toString.f51d8d11.js";import"./_arrayPush.f667b98f.js";import"./LinkTableConfigModal.b585339d.js";import"./omit.f85ed7ec.js";import"./_baseClone.2b814275.js";import"./_baseSlice.213136cd.js";import"./LinkTableFieldConfigModal.056b5e79.js";import"./FieldExtendJsonModal.87ad0384.js";import"./FormSchemaFactory.4d3f70be.js";import"./JUploadModal.vue_vue_type_script_setup_true_lang.0c9bff57.js";import"./_commonjsHelpers.238e4417.js";import"./customExpression.05dc2408.js";import"./OnlineSelectCascade.dcd3a21e.js";import"./BasicTable.7f769694.js";import"./BasicTable.vue_vue_type_style_index_0_lang.734e51fc.js";import"./index.9013d2b9.js";import"./useContentHeight.729fdab1.js";import"./useContentViewHeight.c21fb651.js";import"./usePageContext.a7636151.js";import"./RedoOutlined.a7479f77.js";import"./TableImg.vue_vue_type_style_index_0_lang.c653d5f6.js";import"./useListPage.6b1e9ff2.js";import"./useTable.c77f7905.js";import"./Area.34bf1346.js";import"./LinkTableListPiece.ef0939db.js";import"./JModalTip.00279615.js";import"./EditOutlined.cf2b97fa.js";var vt=Object.defineProperty,ht=Object.defineProperties,Ct=Object.getOwnPropertyDescriptors,ne=Object.getOwnPropertySymbols,Ft=Object.prototype.hasOwnProperty,_t=Object.prototype.propertyIsEnumerable,ie=(t,o,c)=>o in t?vt(t,o,{enumerable:!0,configurable:!0,writable:!0,value:c}):t[o]=c,x=(t,o)=>{for(var c in o||(o={}))Ft.call(o,c)&&ie(t,c,o[c]);if(ne)for(var c of ne(o))_t.call(o,c)&&ie(t,c,o[c]);return t},Dt=(t,o)=>ht(t,Ct(o)),_=(t,o,c)=>new Promise((E,h)=>{var b=p=>{try{C(c.next(p))}catch(m){h(m)}},D=p=>{try{C(c.throw(p))}catch(m){h(m)}},C=p=>p.done?E(p.value):Promise.resolve(p.value).then(b,D);C((c=c.apply(t,o)).next())});const tl=t=>F.get({url:"/online/cgform/head/list",params:t}),al=t=>re(t,0),ll=t=>re(t,1);function re(t,o){return F.delete({url:"/online/cgform/head/deleteBatch",params:{ids:t.join(","),flag:o}},{joinParamsToUrl:!0})}const ol=(t,o)=>F.post({url:`/online/cgform/api/doDbSynch/${t}/${o}`,timeout:12e3,timeoutErrorMessage:"\u540C\u6B65\u6570\u636E\u5E93\u8D85\u65F6\uFF0C\u5DF2\u81EA\u52A8\u5237\u65B0"}),nl=t=>F.post({url:`/online/cgform/head/copyOnline?code=${t}`}),il=(t,o,c)=>F.get({url:`/online/cgform/head/copyOnlineTable/${t}`,params:x({tableName:o},c)}),$={doQueryField:(t,o)=>F.get({url:"/online/cgform/field/listByHeadId",params:x({headId:t},o)}),doQueryIndexes:(t,o)=>F.get({url:"/online/cgform/index/listByHeadId",params:x({headId:t},o)}),doSaveOrUpdate:(t,o)=>o?F.put({url:"/online/cgform/api/editAll",params:t}):F.post({url:"/online/cgform/api/addAll",params:t}),editHead:t=>F.put({url:"/online/cgform/head/edit",params:t})},Bt=Ke({name:"CgformModal",components:{BasicModal:lt,BasicForm:ot,DBAttributeTable:rt,PageAttributeTable:st,CheckDictTable:ut,ForeignKeyTable:dt,IndexTable:ct,QueryTable:ft,ExtendConfigModal:bt,Icon:Ve},emits:["success","register"],props:{actionButton:{type:Boolean,default:!0,required:!1}},setup(t,{emit:o}){const{createMessage:c}=at(),E=g(),h=g(!1);let b={};const D=ee(()=>h.value?"\u7F16\u8F91":"\u65B0\u589E"),C=g(!0),p=g(!1),m=g("dbTable"),O=g(!0),u={dbTable:g(),pageTable:g(),checkTable:g(),fkTable:g(),idxTable:g(),queryTable:g()},J=ee(()=>{var e,a;return(a=(e=E.value)==null?void 0:e.fullScreenRef)!=null?a:!1});te("tables",u),te("fullScreenRef",J);const{formSchemas:Q}=it(t,{onTableTypeChange:he,onIsTreeChange:Ce,ifShowOfSubTableStr:()=>Y}),[K,A]=nt({schemas:Q,showActionButtonGroup:!1,labelAlign:"right"}),{resetFields:V,setFieldsValue:S,validate:N}=A,[q,{closeModal:U}]=qe(e=>{var a;h.value=(a=e==null?void 0:e.isUpdate)!=null?a:!1,h.value?W(e==null?void 0:e.record):pe()}),P=g("");let y=Ue({});const v=tt(()=>Fe(),150);let M=[],Y=!1,j=!1,B=[];const{aiTestMode:se,aiTestTable:ue,aiTableList:de,initVirtualData:ce,tableJsonGetHelper:fe,refreshCacheTableName:be}=gt();function pe(){W({})}function W(e){return _(this,null,function*(){var a;if(C.value=!1,m.value="dbTable",yield V(),b=Object.assign({},e),ye(b),fe(b),ge(b),S(b),P.value=b.tableName,L(1,()=>O.value=!1),h.value)(a=u.dbTable.value)==null||a.setDataSource([]),yield me(b.id),yield Te(b.id),yt(u.pageTable).then(()=>{u.pageTable.value.changePageType(b.tableType==3)});else{let{initialData:l,tempIds:n}=pt();yield Z(l,!0),M=n}})}function me(e){return _(this,null,function*(){p.value=!0;try{let a=yield $.doQueryField(e);p.value=!1,yield Z(a)}finally{p.value=!1}})}function Te(e){return _(this,null,function*(){let a=yield $.doQueryIndexes(e);u.idxTable.value.setDataSource(a)})}function ge(e){let a={};if(e.extConfigJson)try{a=JSON.parse(e.extConfigJson)}catch(l){console.error("online\u6269\u5C55JSON\u8F6C\u6362\u5931\u8D25\uFF1A",l)}y=Object.assign({},mt,a,{isDesForm:e.isDesForm||"N",desFormCode:e.desFormCode||""})}function ye(e){j=e.isTree=="Y",Y=e.tableType===2}function Z(e,a){return _(this,null,function*(){const{dbTable:l,pageTable:n,checkTable:s,fkTable:i,queryTable:T}=u;l.value||(yield G(),yield L(1)),l.value.setDataSource(e,a),setTimeout(()=>{n.value.setDataSource(e,a),s.value.setDataSource(e,a),i.value.setDataSource(e,a),T.value.setDataSource(e,a)},10)})}function ve(e){if(["pageTable","checkTable","fkTable","idxTable","queryTable"].indexOf(e)!==-1){const a=u.dbTable,l=u[e];a.value.tableRef.resetScrollTop(),l.value.syncTable(a)}}function he(e){e===1&&S({themeTemplate:"normal"}),u.pageTable.value.changePageType(e==3)}function Ce(e){e==="Y"?Ae():we()}function H(){v()}function Fe(){return _(this,null,function*(){let{dbTable:e,pageTable:a,checkTable:l,fkTable:n,queryTable:s}=u;yield a.value.syncTable(e),yield l.value.syncTable(e),yield n.value.syncTable(e),yield s.value.syncTable(e)})}function _e(){H()}function De(){H()}function Be(e){let{oldIndex:a,newIndex:l}=e;Re(a,l)}function ke(e){return _(this,null,function*(){let{insertIndex:a,row:l}=e,{pageTable:n,checkTable:s,fkTable:i,queryTable:T}=u;n.value.tableRef.insertRows(l,a),s.value.tableRef.insertRows(l,a),i.value.tableRef.insertRows(l,a),T.value.tableRef.insertRows(l,a)})}function Re(e,a){let{pageTable:l,checkTable:n,fkTable:s,queryTable:i}=u;l.value.tableRef.rowResort(e,a),n.value.tableRef.rowResort(e,a),s.value.tableRef.rowResort(e,a),i.value.tableRef.rowResort(e,a)}function Ee(e){u.pageTable.value.syncFieldShowType(e.row)}function Oe(e){u.pageTable.value.enableQuery(e)}function Ae(){if(!j){let{dbTable:e,pageTable:a,checkTable:l}=u,n=Tt();n=n.filter(s=>!e.value.tableRef.getTableData().map(T=>T.dbFieldName).includes(s.dbFieldName)),B=[],n.forEach(s=>{let i=ze()+"__tempId";B.push(i),s.id=i}),e.value.tableRef.addRows(n,{setActive:!1}),a.value.tableRef.addRows(n,{setActive:!1}),l.value.tableRef.addRows(n,{setActive:!1}),G(()=>H()),j=!0}G(()=>{A.setFieldsValue({treeIdField:"has_child",treeParentIdField:"pid"})})}function we(){if(B&&B.length>0){let{dbTable:e}=u;e.value.tableDeleteLines(B),B=[],j=!1}}function Ie(){let e={};return new Promise((a,l)=>{N().then(n=>a({values:n}),()=>l(I))}).then(a=>(Object.assign(e,a),Se())).then(a=>{Object.assign(e,a);let l=Ne(e);return Pe(l)}).catch(a=>(a===I||(a==null?void 0:a.code)===I?c.warning("\u6821\u9A8C\u672A\u901A\u8FC7"):console.error(a),Promise.reject(null)))}function Se(){return new Promise((e,a)=>_(this,null,function*(){let l=Object.keys(u),n={};for(let s=0;s<l.length;s++){let i=l[s],T=u[i];try{n[i]=yield T.value.validateData(i)}catch(R){R.code===I?m.value=R.activeKey:console.error(R),a(R);return}}e(n)}))}function Ne(e){let a={head:{},fields:[],indexs:[],deleteFieldIds:[],deleteIndexIds:[]};return a.head=Object.assign(b,e.values),a.head.isDesForm=y.isDesForm,a.head.desFormCode=y.desFormCode,delete y.isDesForm,delete y.desFormCode,a.head.extConfigJson=JSON.stringify(y),e.dbTable.tableData.forEach((l,n)=>{let s=l.id,i=Object.assign({},l),T=e.pageTable.tableData[n];i=Object.assign(T,i);let R=e.checkTable.tableData[n];i=Object.assign(R,i);let Je=e.fkTable.tableData[n];i=Object.assign(Je,i);let Qe=e.queryTable.tableData[n];i=Object.assign(Qe,i),s==null||s===""?delete i.id:i.id=s,[].concat(M,B).includes(i.id)&&delete i.id,a.fields.push(i)}),a.deleteFieldIds=e.dbTable.deleteIds,a.indexs=e.idxTable.tableData,a.deleteIndexIds=e.idxTable.deleteIds,a}function Pe(e){return new Promise((a,l)=>{let n=e.fields,s=!0;if(n&&n.length>0){let i=0;for(let T=0;T<n.length;T++)if((n[T].mainField||n[T].mainTable)&&(i+=1),i>1){s=!1;break}}s?a(e):l({code:-1,msg:"\u5916\u952E\u53EA\u5141\u8BB8\u914D\u7F6E\u4E00\u4E2A!",error:I})})}function Me(){C.value=!0,Ie().then(e=>_(this,null,function*(){var a;if(e.fields&&e.fields.length>0)for(let l of e.fields)l.dbFieldName=l.dbFieldName.toLowerCase().trim();(a=e.head)!=null&&a.tableName&&(e.head.tableName=e.head.tableName.toLowerCase().trim()),yield $.doSaveOrUpdate(e,h.value),be(P.value,e.head.tableName),o("success"),L(1,()=>X())}),e=>{console.error(e)}).finally(()=>{C.value=!1})}const[je,Le]=He();function $e(e){return _(this,null,function*(){if(y=e,h.value==!0){let a=et(y);const l={id:b.id,extConfigJson:JSON.stringify(a)};yield $.editHead(l),o("success")}})}function xe(){Le.openModal(!0,{extConfigJson:y})}function X(){O.value=!0,L(1,()=>U())}return Dt(x({},u),{modalRef:E,title:D,confirmLoading:C,tableLoading:p,activeKey:m,onCancel:X,extConfigJson:y,formAction:A,hideTabs:O,onSubmit:Me,onTabsChange:ve,onTableAdded:_e,onTableRemoved:De,onTableDragged:Be,onTableInserted:ke,onTableSyncDbType:Ee,onTableQuery:Oe,onOpenExtConfig:xe,onExtConfigOk:$e,registerForm:K,registerModal:q,registerExtendConfigModal:je,aiTestMode:se,aiTestTable:ue,aiTableList:de,initVirtualData:ce})}}),kt={style:{flex:"1","text-align":"right"}},Rt={key:0,style:{display:"inline-block","text-align":"left",position:"absolute",left:"0"}};function Et(t,o,c,E,h,b){const D=f("a-button"),C=f("BasicForm"),p=f("DBAttributeTable"),m=f("a-tab-pane"),O=f("PageAttributeTable"),u=f("CheckDictTable"),J=f("ForeignKeyTable"),Q=f("IndexTable"),K=f("Icon"),A=f("a-tooltip"),V=f("QueryTable"),S=f("a-tabs"),N=f("a-spin"),q=f("a-select-option"),U=f("a-select"),P=f("ExtendConfigModal"),y=f("BasicModal");return w(),z(y,Xe({ref:"modalRef",title:t.title,width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:t.confirmLoading},t.$attrs,{onCancel:t.onCancel,onRegister:t.registerModal}),{footer:d(()=>[r(D,{onClick:t.onCancel},{default:d(()=>[k("\u5173\u95ED")]),_:1},8,["onClick"]),r(D,{type:"primary",loading:t.confirmLoading,preIcon:"ant-design:save",onClick:t.onSubmit},{default:d(()=>[k("\u4FDD\u5B58")]),_:1},8,["loading","onClick"]),t.aiTestMode?(w(),ae("div",Rt,[r(U,{value:t.aiTestTable,"onUpdate:value":o[1]||(o[1]=v=>t.aiTestTable=v),placeholder:"\u8BF7\u9009\u62E9\u6D4B\u8BD5\u7684\u8868\u7C7B\u578B",getPopupContainer:v=>v.parentElement,style:{width:"250px",margin:"0 10px 0 20px"}},{default:d(()=>[(w(!0),ae(Ye,null,We(t.aiTableList,(v,M)=>(w(),z(q,{key:M,value:v.name},{default:d(()=>[k(Ze(v.title+"\uFF08"+v.name+"\uFF09"),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","getPopupContainer"]),r(D,{type:"primary",ghost:"",onClick:t.initVirtualData},{default:d(()=>[k("\u751F\u6210\u6570\u636E>>")]),_:1},8,["onClick"])])):le("",!0)]),default:d(()=>[r(N,{wrapperClassName:"p-2",spinning:t.confirmLoading},{default:d(()=>[r(C,{onRegister:t.registerForm},{extConfigButton:d(()=>[oe("div",kt,[r(D,{preIcon:"ant-design:setting",onClick:t.onOpenExtConfig},{default:d(()=>[k("\u6269\u5C55\u914D\u7F6E")]),_:1},8,["onClick"])])]),_:1},8,["onRegister"]),r(N,{spinning:t.tableLoading||t.hideTabs},{default:d(()=>[t.hideTabs?le("",!0):(w(),z(S,{key:0,activeKey:t.activeKey,"onUpdate:activeKey":o[0]||(o[0]=v=>t.activeKey=v),animated:"",onChange:t.onTabsChange},{default:d(()=>[r(m,{tab:"\u6570\u636E\u5E93\u5C5E\u6027",key:"dbTable",forceRender:""},{default:d(()=>[r(p,{ref:"dbTable",actionButton:t.actionButton,onAdded:t.onTableAdded,onRemoved:t.onTableRemoved,onDragged:t.onTableDragged,onInserted:t.onTableInserted,onSyncDbType:t.onTableSyncDbType},null,8,["actionButton","onAdded","onRemoved","onDragged","onInserted","onSyncDbType"])]),_:1}),r(m,{tab:"\u9875\u9762\u5C5E\u6027",key:"pageTable",forceRender:""},{default:d(()=>[r(O,{ref:"pageTable"},null,512)]),_:1}),r(m,{tab:"\u6821\u9A8C\u5B57\u6BB5",key:"checkTable",forceRender:""},{default:d(()=>[r(u,{ref:"checkTable"},null,512)]),_:1}),r(m,{tab:"\u5916\u952E",key:"fkTable",forceRender:""},{default:d(()=>[r(J,{ref:"fkTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(m,{tab:"\u7D22\u5F15",key:"idxTable",forceRender:""},{default:d(()=>[r(Q,{ref:"idxTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(m,{key:"queryTable",forceRender:""},{tab:d(()=>[oe("span",null,[k(" \u4E2A\u6027\u67E5\u8BE2\u914D\u7F6E "),r(A,null,{title:d(()=>[k("\u81EA\u5B9A\u4E49\u67E5\u8BE2\u5B57\u6BB5\u63A7\u4EF6\u6548\u679C")]),default:d(()=>[r(K,{icon:"bx:help-circle"})]),_:1})])]),default:d(()=>[r(V,{ref:"queryTable",onQuery:t.onTableQuery},null,8,["onQuery"])]),_:1})]),_:1},8,["activeKey","onChange"]))]),_:1},8,["spinning"])]),_:1},8,["spinning"]),r(P,{onRegister:t.registerExtendConfigModal,parentForm:t.formAction,onOk:t.onExtConfigOk},null,8,["onRegister","parentForm","onOk"])]),_:1},16,["title","confirmLoading","onCancel","onRegister"])}var Ot=Ge(Bt,[["render",Et]]),rl=Object.freeze(Object.defineProperty({__proto__:null,default:Ot},Symbol.toStringTag,{value:"Module"}));export{Ot as C,al as a,ll as b,ol as c,nl as d,il as e,rl as f,tl as l};
